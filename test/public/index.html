<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OpenSSL EVP WASM Test Page</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    .row { display: flex; align-items: center; margin-bottom: 1em; }
    .row label { min-width: 180px; }
    .row input, .row select, .row textarea { margin-right: 1em; }
    .output { width: 400px; height: 2em; }
    .input { width: 200px; }
    button { margin-right: 1em; }
    h1 { margin-bottom: 2em; }
  </style>
</head>
<body>
  <!-- <h1>OpenSSL EVP WASM Test Page</h1> -->

  <!-- Generate Bytes -->
  <h3>Generate Random Bytes</h3>
  <div class="row">
    <label for="gen-len">Length:</label>
    <input type="number" id="gen-len" class="input" value="32" />
    <button onclick="generateBytes()">Generate</button>
    <label for="gen-output">Output:</label>
    <textarea id="gen-output" class="output" readonly></textarea>
    <button onclick="copyToClipboard('gen-output')">Copy</button>
  </div>

  <!-- Symmetric EVP -->
  <h3>Symmetric Encryption/Decryption</h3>
  <div class="row">
    <label for="sym-alg">Algorithm:</label>
    <select id="sym-alg" class="input"></select>
    <label for="sym-key">Key (Base64):</label>
    <input type="text" id="sym-key" class="input" />
    <button onclick="pasteFromClipboard('sym-key')">Paste</button>
    <label for="sym-iv">IV (Base64):</label>
    <input type="text" id="sym-iv" class="input" />
    <button onclick="pasteFromClipboard('sym-iv')">Paste</button>
    <label for="sym-aad">AAD (Base64):</label>
    <input type="text" id="sym-aad" class="input" />
    <button onclick="pasteFromClipboard('sym-aad')">Paste</button>
  </div>
  <h4>Encryption</h4>
  <div class="row">
    <label for="sym-enc-input">Plaintext:</label>
    <input type="text" id="sym-enc-input" class="input" />
    <button onclick="symEncrypt()">Encrypt</button>
    <label for="sym-enc-output">Ciphertext:</label>
    <textarea id="sym-enc-output" class="output" readonly></textarea>
    <button onclick="copyToClipboard('sym-enc-output')">Copy</button>
    <label for="sym-enc-tag">Tag:</label>
    <textarea id="sym-enc-tag" class="output" readonly></textarea>
    <button onclick="copyToClipboard('sym-enc-tag')">Copy</button>
  </div>
  <h4>Decryption</h4>
  <div class="row">
    <label for="sym-dec-input">Ciphertext:</label>
    <input type="text" id="sym-dec-input" class="input" />
    <button onclick="pasteFromClipboard('sym-dec-input')">Paste</button>
    <label for="sym-dec-tag">Tag:</label>
    <input type="text" id="sym-dec-tag" class="input" />
    <button onclick="pasteFromClipboard('sym-dec-tag')">Paste</button>
    <button onclick="symDecrypt()">Decrypt</button>
    <label for="sym-dec-output">Plaintext:</label>
    <textarea id="sym-dec-output" class="output" readonly></textarea>
  </div>

  <!-- PQC EVP -->
  <h3>Post-Quantum Cryptography (PQC) Key Encapsulation</h3>
  <div class="row">
    <label for="pqc-alg">Algorithm:</label>
    <select id="pqc-alg" class="input"></select>
  </div>
  <h4>Key Generation</h4>
  <div class="row">
    <button onclick="pqcKeygen()">Generate Key Pair</button>
    <label for="pqc-keygen-pubkey">Public Key:</label>
    <textarea id="pqc-keygen-pubkey" class="output" readonly></textarea>
    <button onclick="copyToClipboard('pqc-keygen-pubkey')">Copy</button>
    <label for="pqc-keygen-privkey">Private Key:</label>
    <textarea id="pqc-keygen-privkey" class="output" readonly></textarea>
    <button onclick="copyToClipboard('pqc-keygen-privkey')">Copy</button>
  </div>
  <h4>Encapsulation</h4>
  <div class="row">
    <label for="pqc-encaps-pubkey">Public Key:</label>
    <input type="text" id="pqc-encaps-pubkey" class="input" />
    <button onclick="pasteFromClipboard('pqc-encaps-pubkey')">Paste</button>
    <button onclick="pqcEncap()">Encapsulate</button>
    <label for="pqc-encaps-ciphertext">Ciphertext:</label>
    <textarea id="pqc-encaps-ciphertext" class="output" readonly></textarea>
    <button onclick="copyToClipboard('pqc-encaps-ciphertext')">Copy</button>
    <label for="pqc-encaps-secret">Shared Secret:</label>
    <textarea id="pqc-encaps-secret" class="output" readonly></textarea>
    <button onclick="copyToClipboard('pqc-encaps-secret')">Copy</button>
  </div>
  <h4>Decapsulation</h4>
  <div class="row">
    <label for="pqc-decaps-privkey">Private Key:</label>
    <input type="text" id="pqc-decaps-privkey" class="input" />
    <button onclick="pasteFromClipboard('pqc-decaps-privkey')">Paste</button>
    <label for="pqc-decaps-ciphertext">Ciphertext:</label>
    <input type="text" id="pqc-decaps-ciphertext" class="input" />
    <button onclick="pasteFromClipboard('pqc-decaps-ciphertext')">Paste</button>
    <button onclick="pqcDecap()">Decapsulate</button>
    <label for="pqc-decaps-secret">Shared Secret:</label>
    <textarea id="pqc-decaps-secret" class="output" readonly></textarea>
    <button onclick="copyToClipboard('pqc-decaps-secret')">Copy</button>
  </div>

  <script src="bundle.js"></script>
  <script>
    let evp;
    window.onload = async function() {
      const factory = await import('./openssl_wasm.js');
      const wasm = await factory.default();
      evp = new window.OpensslEVP(wasm);

      // Populate sym-alg combo box
      const symAlgSelect = document.getElementById('sym-alg');
      const algs = evp.symmetric.algorithms();
      symAlgSelect.innerHTML = '';
      algs.forEach(alg => {
        const opt = document.createElement('option');
        opt.value = alg;
        opt.textContent = alg;
        symAlgSelect.appendChild(opt);
      });

      // Populate pqc-alg combo box
      const pqcAlgSelect = document.getElementById('pqc-alg');
      const pqcAlgs = evp.pqc.algorithms();
      pqcAlgSelect.innerHTML = '';
      pqcAlgs.forEach(alg => {
        const opt = document.createElement('option');
        opt.value = alg;
        opt.textContent = alg;
        pqcAlgSelect.appendChild(opt);
      });
    }

    function copyToClipboard(id) {
      const el = document.getElementById(id);
      el.select();
      document.execCommand('copy');
    }
    function pasteFromClipboard(id) {
      navigator.clipboard.readText().then(text => {
        document.getElementById(id).value = text;
      });
    }
    function b64ToArray(str) {
      return Uint8Array.from(atob(str), (c) => c.charCodeAt(0));
    }
    function arrayToB64(bytes) {
      return btoa(String.fromCharCode(...bytes));
    }
    async function generateBytesHelper(numBytes) {
      try {
        const retval = await evp.generateRandomBytes(numBytes);
        return arrayToB64(retval);
      } catch(err) {
        return 'Error: ' + err;
      }
    }
    async function generateBytes() {
      const numBytes = parseInt(document.getElementById('gen-len').value);
      document.getElementById('gen-output').value = await generateBytesHelper(numBytes);
    }
    async function symEncrypt() {
      const alg = document.getElementById('sym-alg').value;
      const key = b64ToArray(document.getElementById('sym-key').value);
      const iv = b64ToArray(document.getElementById('sym-iv').value);
      const aad = b64ToArray(document.getElementById('sym-aad').value);
      const plaintextString = document.getElementById('sym-enc-input').value;
      const plaintext = new TextEncoder().encode(plaintextString);
      try {
        const { ciphertext, tag } = await evp.symmetric.encrypt(alg, { key, iv, aad }, plaintext);
        document.getElementById('sym-enc-output').value = arrayToB64(ciphertext);
        document.getElementById('sym-enc-tag').value = arrayToB64(tag);
      } catch(err) {
        document.getElementById('sym-enc-output').value = 'Error: ' + err;
      }
    }
    async function symDecrypt() {
      const alg = document.getElementById('sym-alg').value;
      const key = b64ToArray(document.getElementById('sym-key').value);
      const iv = b64ToArray(document.getElementById('sym-iv').value);
      const aad = b64ToArray(document.getElementById('sym-aad').value);
      const tag = b64ToArray(document.getElementById('sym-dec-tag').value);
      const ciphertext = b64ToArray(document.getElementById('sym-dec-input').value);
      try {
        const plaintext = await evp.symmetric.decrypt(alg, { key, iv, aad, tag }, ciphertext);
        document.getElementById('sym-dec-output').value = String.fromCharCode(...plaintext);
      } catch(err) {
        document.getElementById('sym-dec-output').value = 'Error: ' + err;
      }
    }
    async function pqcKeygen() {
      const alg = document.getElementById('pqc-alg').value;
      try {
        const { publicKey, privateKey } = await evp.pqc.keygen(alg);
        document.getElementById('pqc-keygen-pubkey').value = arrayToB64(publicKey);
        document.getElementById('pqc-keygen-privkey').value = arrayToB64(privateKey);
      } catch(err) {
        document.getElementById('pqc-keygen-pubkey').value = 'Error: ' + err;
      }
    }
    async function pqcEncap() {
      const alg = document.getElementById('pqc-alg').value;
      const pubkey = b64ToArray(document.getElementById('pqc-encaps-pubkey').value);
      try {
        const { ciphertext, sharedSecret } = await evp.pqc.encapsulate(alg, pubkey);
        document.getElementById('pqc-encaps-ciphertext').value = arrayToB64(ciphertext);
        document.getElementById('pqc-encaps-secret').value = arrayToB64(sharedSecret);
      } catch(err) {
        document.getElementById('pqc-encaps-ciphertext').value = 'Error: ' + err;
      }
    }
    async function pqcDecap() {
      const alg = document.getElementById('pqc-alg').value;
      const privkey = b64ToArray(document.getElementById('pqc-decaps-privkey').value);
      const ciphertext = b64ToArray(document.getElementById('pqc-decaps-ciphertext').value);
      try {
        const sharedSecret = await evp.pqc.decapsulate(alg, privkey, ciphertext);
        document.getElementById('pqc-decaps-secret').value = arrayToB64(sharedSecret);
      } catch(err) {
        document.getElementById('pqc-decaps-secret').value = 'Error: ' + err;
      }
    }
  </script>
</body>
</html>
